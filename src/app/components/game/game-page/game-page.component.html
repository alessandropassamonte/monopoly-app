<!-- src/app/components/game/game-page/game-page.component.html -->
<!-- VERSIONE AGGIORNATA con funzionalità migliorate -->

<ion-header>
  <ion-toolbar color="primary">
    <ion-title class="monopoly-title">
      <ion-icon name="diamond-outline" class="title-icon"></ion-icon>
      Monopoly Bank - {{sessionCode}}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showMenu()">
        <ion-icon name="menu"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content style="--background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); 
                    min-height: 100vh; display: block !important;">

  <div style="padding: 1rem; max-width: 1200px; margin: 0 auto;">

    <!-- Current Player Indicator - FIXED: Ora si aggiorna correttamente -->
    <div *ngIf="currentPlayer" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
                color: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; 
                box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3); text-align: center;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
        <div [style]="'width: 60px; height: 60px; border-radius: 50%; 
                      background: rgba(255,255,255,0.2); 
                      display: flex; align-items: center; justify-content: center;'">
          <ion-icon name="person" style="font-size: 2rem; color: white;"></ion-icon>
        </div>
        <div>
          <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: bold;">
            {{currentPlayer.name}}
            <span *ngIf="currentPlayer.host"
              style="color: rgba(255,255,255,0.9); font-size: 0.8rem; margin-left: 0.5rem;">👑 HOST</span>
          </h2>
          <div style="font-size: 1.8rem; font-weight: bold; font-family: 'Courier New', monospace;">
            {{gameService.formatCurrency(currentPlayer.balance)}}
          </div>
          <div style="font-size: 1rem; opacity: 0.9; margin-top: 0.3rem;">
            {{currentPlayer.propertiesCount}} proprietà possedute
          </div>
        </div>
      </div>
    </div>

    <!-- Players Balance Overview -->
    <div style="margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="width: 4px; height: 2rem; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
                    border-radius: 2px;"></div>
        <h3 style="font-family: 'Trebuchet MS', Arial, sans-serif; 
                   color: #2d3748; margin: 0; font-size: 1.4rem; font-weight: bold;">
          👥 Altri Giocatori
        </h3>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
                  gap: 1.5rem;">
        <div *ngFor="let player of currentSession?.players" [hidden]="player.id === currentPlayer?.id" [style]="'background: white; border-radius: 20px; padding: 1.5rem; 
                      display: flex; align-items: center; gap: 1rem; 
                      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); 
                      border-left: 6px solid ' + getPlayerColorHex(player.color) + '; 
                      transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden;'"
          (click)="selectPlayer(player)"
          onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 15px 40px rgba(0, 0, 0, 0.15)';"
          onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)';">

          <!-- Background Pattern -->
          <div style="position: absolute; top: -50%; right: -20%; width: 150px; height: 150px; 
                      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); 
                      border-radius: 50%; pointer-events: none;"></div>

          <!-- Player Avatar -->
          <div [style]="'width: 70px; height: 70px; border-radius: 50%; 
                        background: linear-gradient(135deg, ' + getPlayerColorHex(player.color) + ' 0%, ' + darkenColor(getPlayerColorHex(player.color), 20) + ' 100%); 
                        display: flex; align-items: center; justify-content: center; 
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); flex-shrink: 0;'">
            <ion-icon name="person-outline"
              style="color: white; font-size: 2rem; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3));"></ion-icon>
          </div>

          <!-- Player Info -->
          <div style="flex: 1; z-index: 1;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <h4 style="margin: 0; font-size: 1.3rem; color: #2d3748; font-weight: bold;">
                {{player.name}}
              </h4>
              <span *ngIf="player.host" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
                           color: white; padding: 0.2rem 0.6rem; border-radius: 12px; 
                           font-size: 0.7rem; font-weight: bold; 
                           box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);">
                👑 HOST
              </span>
            </div>

            <div style="font-weight: bold; color: #38a169; font-size: 1.4rem; 
                        font-family: 'Courier New', monospace; margin-bottom: 0.3rem;">
              {{gameService.formatCurrency(player.balance)}}
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; 
                        font-size: 0.9rem; color: #4a5568;">
              <ion-icon name="business-outline" style="font-size: 1rem;"></ion-icon>
              <span>{{player.propertiesCount}} proprietà</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div style="margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="width: 4px; height: 2rem; background: linear-gradient(135deg, #3182ce 0%, #2c5aa0 100%); 
                    border-radius: 2px;"></div>
        <h3 style="font-family: 'Trebuchet MS', Arial, sans-serif; 
                   color: #2d3748; margin: 0; font-size: 1.4rem; font-weight: bold;">
          🎯 Azioni Rapide
        </h3>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
                  gap: 1rem;">

        <!-- Trasferimento Denaro -->
        <button (click)="showTransferModal()" [disabled]="!currentPlayer" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.5rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" [style.opacity]="currentPlayer ? '1' : '0.5'"
          onmouseover="if (this.style.opacity === '1') { this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.4)'; }"
          onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)';">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <ion-icon name="arrow-forward" style="font-size: 1.5rem;"></ion-icon>
            </div>
            <div>
              <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Trasferisci Denaro</h4>
              <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Invia soldi ad altri giocatori</p>
            </div>
          </div>
        </button>
        <div class="money-pair">
          <!-- Ricevi dalla Banca -->
          <button (click)="showBankPaymentFromBankModal()" [disabled]="!currentPlayer" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.0rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);" [style.opacity]="currentPlayer ? '1' : '0.5'"
            onmouseover="if (this.style.opacity === '1') { this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(72, 187, 120, 0.4)'; }"
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(72, 187, 120, 0.3)';">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 25px; height: 25px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <ion-icon name="arrow-down" style="font-size: 1.0rem;"></ion-icon>
              </div>
              <div>
                <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Ricevi dalla Banca</h4>
                <!-- <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Stipendio, premi, vincite</p> -->
              </div>
            </div>
          </button>

          <!-- Paga alla Banca -->
          <button (click)="showBankPaymentToBankModal()" [disabled]="!currentPlayer" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.0rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);" [style.opacity]="currentPlayer ? '1' : '0.5'"
            onmouseover="if (this.style.opacity === '1') { this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(237, 137, 54, 0.4)'; }"
            onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(237, 137, 54, 0.3)';">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="width: 25px; height: 25px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <ion-icon name="arrow-up" style="font-size: 1.0rem;"></ion-icon>
              </div>
              <div>
                <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Paga alla Banca</h4>
                <!-- <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Tasse, multe, costi</p> -->
              </div>
            </div>
          </button>
        </div>
        <!-- Gestione Proprietà -->
        <button (click)="showPropertiesModal()" [disabled]="!currentPlayer" style="background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.5rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(128, 90, 213, 0.3);" [style.opacity]="currentPlayer ? '1' : '0.5'"
          onmouseover="if (this.style.opacity === '1') { this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(128, 90, 213, 0.4)'; }"
          onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(128, 90, 213, 0.3)';">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <ion-icon name="business" style="font-size: 1.5rem;"></ion-icon>
            </div>
            <div>
              <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Gestione Proprietà</h4>
              <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">🔍 Compra, costruisci, cerca</p>
            </div>
          </div>
        </button>


        <!-- NUOVO: Pagamento Affitto Migliorato -->
        <button (click)="showRentPaymentModal()" [disabled]="!currentPlayer" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.5rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);" [style.opacity]="currentPlayer ? '1' : '0.5'"
          onmouseover="if (this.style.opacity === '1') { this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(220, 38, 38, 0.4)'; }"
          onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(220, 38, 38, 0.3)';">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <ion-icon name="home" style="font-size: 1.5rem;"></ion-icon>
            </div>
            <div>
              <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Paga Affitto</h4>
              <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">🎯 Scegli giocatore e proprietà</p>
            </div>
          </div>
        </button>

        <!-- NUOVO: Trasferimento Multiplo Proprietà -->
        <button (click)="showTradeModal()"  style="background: linear-gradient(135deg, #059669 0%, #047857 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.5rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);" [style.opacity]="currentPlayer ? '1' : '0.5'"
          onmouseover="if (this.style.opacity === '1') { this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(5, 150, 105, 0.4)'; }"
          onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(5, 150, 105, 0.3)';">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <ion-icon name="git-branch" style="font-size: 1.5rem;"></ion-icon>
            </div>
            <div>
              <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Scambio Negoziato</h4>
              <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">💰 Più proprietà + denaro</p>
            </div>
          </div>
        </button>

        <!-- Gestione Patrimonio -->
        <button (click)="showWealthManagementModal()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
                       color: white; border: none; border-radius: 15px; padding: 1.5rem; 
                       text-align: left; cursor: pointer; transition: all 0.3s ease; 
                       box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);"
          onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 25px rgba(16, 185, 129, 0.4)';"
          onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)';">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
                        border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <ion-icon name="analytics" style="font-size: 1.5rem;"></ion-icon>
            </div>
            <div>
              <h4 style="margin: 0 0 0.3rem 0; font-size: 1.1rem; font-weight: bold;">Analisi Patrimonio</h4>
              <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">📊 Patrimonio, liquidazioni, bancarotta</p>
            </div>
          </div>
        </button>
      </div>
    </div>

    <!-- Warning se non c'è currentPlayer -->
    <div *ngIf="!currentPlayer" style="background: #fed7d7; color: #9b2c2c; padding: 2rem; 
                 border-radius: 15px; text-align: center; margin-bottom: 2rem; 
                 border-left: 6px solid #e53e3e;">
      <ion-icon name="warning" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></ion-icon>
      <h4 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: bold;">
        Giocatore Non Identificato
      </h4>
      <p style="margin: 0; font-size: 1rem;">
        Torna alla lobby per selezionare il tuo giocatore
      </p>
    </div>

    <!-- Recent Transactions -->
    <div style="margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div style="width: 4px; height: 2rem; background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); 
                      border-radius: 2px;"></div>
          <h3 style="font-family: 'Trebuchet MS', Arial, sans-serif; 
                     color: #2d3748; margin: 0; font-size: 1.4rem; font-weight: bold;">
            📊 Transazioni Recenti
          </h3>
        </div>

        <button (click)="refreshTransactions()" style="background: #e2e8f0; color: #4a5568; border: none; border-radius: 10px; 
                       padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s ease; 
                       display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='#cbd5e0';"
          onmouseout="this.style.background='#e2e8f0';">
          <ion-icon name="refresh" style="font-size: 1rem;"></ion-icon>
          <span style="font-size: 0.9rem; font-weight: 500;">Aggiorna</span>
        </button>
      </div>

      <div style="background: white; border-radius: 20px; padding: 1.5rem; 
                  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); min-height: 300px;">

        <!-- Empty State -->
        <div *ngIf="!recentTransactions || recentTransactions.length === 0"
          style="text-align: center; padding: 3rem 1rem; color: #4a5568;">
          <ion-icon name="receipt-outline"
            style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></ion-icon>
          <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">Nessuna transazione</h4>
          <p style="margin: 0; opacity: 0.7;">Le transazioni di gioco appariranno qui</p>
        </div>

        <!-- Transactions List -->
        <div *ngIf="recentTransactions && recentTransactions.length > 0">
          <div *ngFor="let transaction of recentTransactions; let i = index" [style]="'padding: 1rem; border-radius: 12px; border-left: 4px solid ' + getTransactionColor(transaction) + '; 
                        background: ' + getTransactionBg(transaction) + '; margin-bottom: 1rem; 
                        transition: all 0.2s ease; cursor: pointer;'"
            onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0px)'">

            <div style="display: flex; justify-content: between; align-items: start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <ion-icon [name]="getTransactionIcon(transaction)"
                    [style]="'font-size: 1.2rem; color: ' + getTransactionColor(transaction)"></ion-icon>
                  <h5 style="margin: 0; font-size: 1rem; font-weight: bold; color: #2d3748;">
                    {{transaction.description}}
                  </h5>
                </div>

                <div style="font-size: 0.9rem; color: #4a5568; margin-bottom: 0.3rem;">
                  <span style="font-weight: 500;">{{transaction.fromPlayerName}}</span>
                  <ion-icon name="arrow-forward" style="margin: 0 0.5rem; font-size: 0.8rem;"></ion-icon>
                  <span style="font-weight: 500;">{{transaction.toPlayerName}}</span>
                </div>

                <div style="font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 0.3rem;">
                  <ion-icon name="time-outline" style="font-size: 0.8rem;"></ion-icon>
                  {{formatTime(transaction.timestamp)}}
                </div>
              </div>

              <div [style]="'font-weight: bold; font-size: 1.2rem; font-family: Courier New, monospace; color: ' 
                           + getAmountColor(transaction)" class="transaction-amount">
                {{gameService.formatCurrency(transaction.amount)}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</ion-content>

<style>
  @keyframes pulse {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.7;
    }
  }

  /* NUOVO: Stili aggiuntivi per le nuove funzionalità */
  .multi-transfer-modal {
    --width: 95%;
    --max-width: 600px;
    --height: 85%;
    --border-radius: 20px;
  }

  .rent-properties-modal {
    --width: 90%;
    --max-width: 500px;
    --height: 75%;
    --border-radius: 15px;
  }

  @media (max-width: 768px) {
    .players-grid {
      grid-template-columns: 1fr !important;
    }

    .action-buttons {
      grid-template-columns: 1fr !important;
    }

    .multi-transfer-modal,
    .rent-properties-modal {
      --width: 100%;
      --height: 100%;
      --border-radius: 0px;
    }
  }

  @media (max-width: 480px) {
    .transaction-item {
      padding: 1rem 0.75rem !important;
    }

    .transaction-amount {
      font-size: 1rem !important;
    }

    .current-player-indicator {
      padding: 1rem !important;
    }

    .action-button {
      padding: 1.2rem !important;
    }
  }
</style>